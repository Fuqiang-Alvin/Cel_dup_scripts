Code used in Figure 6.
