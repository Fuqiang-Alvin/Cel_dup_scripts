Code used in Figure 4.
