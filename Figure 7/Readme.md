Code used in Figure 7.
